---
description: Go code style, conventions, and best practices for DockUp
globs:
  - "**/*.go"
alwaysApply: false
---

# Go Code Rules for DockUp Agent

## General Guidelines
- Follow standard Go formatting (gofmt)
- Use goimports for import organization
- Write idiomatic Go code
- Keep functions small and focused
- Use meaningful variable and function names

## Code Style
- Use camelCase for unexported functions and variables
- Use PascalCase for exported functions and types
- Use short variable names in small scopes (i, j, k for loops)
- Use descriptive names for package-level variables
- Group related declarations together

## Error Handling
- Always handle errors explicitly
- Use fmt.Errorf with %w for error wrapping (Go 1.13+)
- Return errors, don't log and continue
- Provide context in error messages
- Use errors.Is() and errors.As() for error checking

Example:
```go
if err != nil {
    return fmt.Errorf("failed to load config: %w", err)
}
```

## Concurrency
- Use sync.RWMutex for read-heavy operations
- Use sync.Mutex for write operations
- Always unlock mutexes with defer
- Document why locks are needed
- Use sync.Map for concurrent map access when appropriate

## HTTP Handlers
- Return appropriate HTTP status codes
- Use http.Error() for error responses
- Validate input before processing
- Use context.Context for request cancellation
- Set appropriate headers (Content-Type, etc.)

## Logging
- Use log.Printf() for informational messages
- Use emoji prefixes for visual clarity (✅, ❌, ⚠️, etc.)
- Include context in log messages
- Log errors with full context
- Use structured logging when possible

## Configuration
- Use struct tags for JSON unmarshaling
- Validate configuration on load
- Provide default values where appropriate
- Use flag package for command-line flags
- Document configuration options

## Security
- Validate all user input
- Use constant-time comparisons for secrets (hmac.Equal)
- Never log sensitive information (secrets, tokens)
- Use secure random number generation (crypto/rand)
- Validate webhook signatures before processing

## Docker/System Commands
- Use exec.Command for system commands
- Always set command directory (cmd.Dir)
- Capture and log command output
- Handle command failures gracefully
- Use context for command timeouts when appropriate

## DockUp-Specific
- Use /etc/dockup/registry.json for app registry
- Use /opt/dockup/apps/ for app directories
- Use /etc/dockup/github-app.json for GitHub App config
- Lock deployments per app to prevent race conditions
- Cache GitHub installation tokens with expiration
- Use systemd for service management

## Testing
- Write unit tests for all exported functions
- Use table-driven tests when appropriate
- Test error cases
- Use test helpers for common setup
- Mock external dependencies

## Documentation
- Add package-level documentation
- Document exported functions and types
- Add examples for complex functions
- Document configuration structures
- Keep comments up to date with code
